<main class="flex-1 w-full px-4 sm:px-6 lg:px-10 py-6">
  @if (loading) {
    <div class="rounded-2xl border border-[#4B3621]/15 bg-white/70 p-6">
      <p class="text-sm text-[#6E5C4B]">Cargando productos...</p>
    </div>
  } @else if (errorMsg) {
    <div class="rounded-2xl border border-red-500/20 bg-red-50 p-6">
      <p class="text-sm text-red-700">{{ errorMsg }}</p>
    </div>
  } @else {
    <div class="grid grid-cols-1 xl:grid-cols-12 gap-6">
      <!-- Columna izquierda, clientes y productos -->
      <section class="xl:col-span-7 space-y-6">
        <!-- Card Cliente -->
        <div class="rounded-2xl border border-[#4B3621]/15 bg-white/70 p-5">
          <div class="flex items-center justify-between gap-3">
            <h3 class="text-base sm:text-lg font-extrabold text-[#4B3621]">
              Cliente
            </h3>

            @if (selectedCustomer) {
              <button
                data-testid="customer-clear-btn"
                type="button"
                (click)="clearCustomer()"
                class="h-12 rounded-xl border border-[#4B3621]/25 bg-white px-5 text-sm font-bold text-[#4B3621] hover:bg-[#F5F5DC] active:scale-[0.99]"
              >
                Quitar
              </button>
            }
          </div>

          @if (selectedCustomer) {
            <!-- Cliente seleccionado -->
            <div
              class="mt-4 rounded-2xl border border-[#4B3621]/10 bg-[#F5F5DC]/70 p-4"
            >
              <p class="text-sm sm:text-base font-extrabold text-[#4B3621]">
                {{ selectedCustomer.name }}
              </p>
              <p class="text-xs sm:text-sm text-[#6E5C4B]">
                {{ selectedCustomer.phoneOrEmail }}
              </p>

              @if (discountPercent > 0) {
                <p
                  class="mt-3 inline-flex items-center gap-2 rounded-full bg-[#FFBF00]/30 px-4 py-1.5 text-sm font-extrabold text-[#4B3621]"
                >
                  Descuento: {{ discountPercent }}%
                </p>
              }
            </div>
          } @else {
            <p class="mt-3 text-sm text-[#6E5C4B]">
              Busca un cliente para aplicar descuentos por compras
            </p>
          }

          <div class="mt-4 flex flex-col sm:flex-row gap-3 items-end">
            <div class="flex-1">
              <label class="block text-xs font-bold text-[#6E5C4B] mb-1">
                Buscar cliente
              </label>

              <input
                data-testid="customer-search-input"
                type="text"
                class="h-12 w-full rounded-xl border border-[#8B6F47]/40 bg-white/80 px-4 text-sm sm:text-base text-[#4B3621] outline-none focus:border-[#4B3621]"
                placeholder="Nombre, email o teléfono"
                [value]="customerQuery"
                (input)="customerQuery = $any($event.target).value"
              />
            </div>

            <button
              data-testid="customer-search-btn"
              type="button"
              (click)="searchCustomers()"
              [disabled]="searchingCustomers"
              class="h-12 rounded-xl bg-[#4B3621] px-6 text-sm sm:text-base font-extrabold text-[#F5F5DC] hover:opacity-95 active:scale-[0.99] disabled:opacity-60"
            >
              @if (searchingCustomers) {
                Buscando...
              } @else {
                Buscar
              }
            </button>
          </div>

          <!-- Resultado -->
          @if (customers.length > 0) {
            <div class="mt-4 space-y-2">
              @for (c of customers; track c.id) {
                <div
                  class="flex items-center justify-between gap-3 rounded-2xl border border-[#4B3621]/10 bg-white/70 p-3"
                >
                  <div class="min-w-0">
                    <p
                      class="text-sm sm:text-base font-extrabold text-[#4B3621] truncate"
                    >
                      {{ c.name }}
                    </p>
                    <p class="text-xs sm:text-sm text-[#6E5C4B] truncate">
                      {{ c.phoneOrEmail }}
                    </p>
                  </div>

                  <button
                    data-testid="customer-select-btn"
                    type="button"
                    (click)="selectCustomer(c)"
                    class="shrink-0 h-12 rounded-xl bg-[#FFBF00] px-5 text-sm font-extrabold text-[#4B3621] hover:brightness-95 active:scale-[0.99]"
                  >
                    Seleccionar
                  </button>
                </div>
              }
            </div>
          } @else {
            @if (hasSearchedCustomers && !searchingCustomers) {
              <p class="mt-4 text-xs sm:text-sm text-[#6E5C4B]">
                No se encontraron clientes con ese criterio
              </p>
            }
          }

          <!-- Crear cliente -->
          @if (!selectedCustomer) {
            <div
              class="mt-5 rounded-2xl border border-[#4B3621]/10 bg-white/60 p-4"
            >
              <p class="text-sm sm:text-base font-extrabold text-[#4B3621]">
                Crear cliente
              </p>

              <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label class="block text-xs font-bold text-[#6E5C4B] mb-1">
                    Nombre
                  </label>
                  <input
                    type="text"
                    class="h-12 w-full rounded-xl border border-[#8B6F47]/40 bg-white/80 px-4 text-sm sm:text-base text-[#4B3621] outline-none focus:border-[#4B3621]"
                    placeholder="Ej. Juan Pérez"
                    [value]="createCustomerName"
                    (input)="createCustomerName = $any($event.target).value"
                  />
                </div>

                <div>
                  <label class="block text-xs font-bold text-[#6E5C4B] mb-1">
                    Teléfono o Email
                  </label>
                  <input
                    type="text"
                    class="h-12 w-full rounded-xl border border-[#8B6F47]/40 bg-white/80 px-4 text-sm sm:text-base text-[#4B3621] outline-none focus:border-[#4B3621]"
                    placeholder="Ej. 4491234567 o correo@demo.com"
                    [value]="createCustomerContact"
                    (input)="createCustomerContact = $any($event.target).value"
                  />
                </div>
              </div>

              <div class="mt-3 flex items-center justify-between gap-3">
                <button
                  type="button"
                  (click)="createCustomer()"
                  [disabled]="creatingCustomer"
                  class="h-12 rounded-xl bg-[#4B3621] px-6 text-sm sm:text-base font-extrabold text-[#F5F5DC] hover:opacity-95 active:scale-[0.99] disabled:opacity-60"
                >
                  @if (creatingCustomer) {
                    Creando...
                  } @else {
                    Crear
                  }
                </button>

                @if (createCustomerMsg) {
                  <p class="text-xs sm:text-sm text-[#6E5C4B]">
                    {{ createCustomerMsg }}
                  </p>
                }
              </div>
            </div>
          }
        </div>

        <!-- CARD Productos-->
        <div class="rounded-2xl border border-[#4B3621]/15 bg-white/70 p-5">
          <div class="flex items-center justify-between gap-3">
            <h3 class="text-base sm:text-lg font-extrabold text-[#4B3621]">
              Productos
            </h3>
            <p class="text-xs sm:text-sm text-[#6E5C4B]">
              Toca “Agregar” para mandar al carrito
            </p>
          </div>

          @if (products.length === 0) {
            <p class="mt-4 text-sm text-[#6E5C4B]">
              No hay productos disponibles.
            </p>
          } @else {
            <div
              class="mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3"
            >
              @for (p of products; track p.id) {
                <div
                  class="rounded-2xl border border-[#4B3621]/10 bg-white/70 p-4 flex items-start justify-between gap-3"
                >
                  <div class="min-w-0">
                    <p
                      class="text-sm sm:text-base font-extrabold text-[#4B3621] truncate"
                    >
                      {{ p.name }}
                    </p>
                    <p class="text-xs sm:text-sm text-[#6E5C4B]">
                      ${{ p.price }} · Stock: {{ p.stock }}
                    </p>
                  </div>

                  <!-- Botón Agregar -->
                  <button
                    data-testid="product-add-btn"
                    type="button"
                    (click)="addToCart(p)"
                    [disabled]="p.stock <= 0"
                    class="shrink-0 h-12 rounded-xl px-5 text-sm font-extrabold transition-transform duration-150 active:scale-[0.99] disabled:cursor-not-allowed disabled:opacity-50 disabled:bg-gray-300 disabled:text-gray-600 bg-[#FFBF00] text-[#4B3621] hover:brightness-95 hover:shadow-md"
                  >
                    Agregar
                  </button>
                </div>
              }
            </div>
          }
        </div>
      </section>

      <!-- Columna derecha Carrito, Totales y Ticket -->
      <section class="xl:col-span-5 space-y-6">
        <!-- Card Carrito y Totales -->
        <div class="rounded-2xl border border-[#4B3621]/15 bg-white/70 p-5">
          <div class="flex items-center justify-between gap-3">
            <h3 class="text-base sm:text-lg font-extrabold text-[#4B3621]">
              Carrito
            </h3>

            @if (cart.length > 0) {
              <p class="text-xs sm:text-sm text-[#6E5C4B]">
                {{ cart.length }} artículo(s)
              </p>
            }
          </div>

          @if (cart.length === 0) {
            <p class="mt-4 text-sm text-[#6E5C4B]">Aún no agregas productos.</p>
          } @else {
            <div class="mt-4 space-y-3">
              @for (item of cart; track item.product.id) {
                <div
                  class="rounded-2xl border border-[#4B3621]/10 bg-white/80 p-4"
                >
                  <div class="flex items-start justify-between gap-3">
                    <div class="min-w-0">
                      <p
                        class="text-sm sm:text-base font-extrabold text-[#4B3621] truncate"
                      >
                        {{ item.product.name }}
                      </p>
                      <p class="text-xs sm:text-sm text-[#6E5C4B]">
                        ${{ item.product.price }} · Stock:
                        {{ item.product.stock }}
                      </p>
                    </div>

                    <button
                      type="button"
                      (click)="removeFromCart(item.product.id)"
                      class="h-12 rounded-xl border border-[#4B3621]/25 bg-white px-5 text-sm font-bold text-[#4B3621] hover:bg-[#F5F5DC] active:scale-[0.99]"
                    >
                      Quitar
                    </button>
                  </div>

                  <div class="mt-3 flex items-center justify-between gap-3">
                    <div class="flex items-center gap-2">
                      <label class="text-xs font-bold text-[#6E5C4B]">
                        Cantidad
                      </label>

                      <input
                        type="number"
                        min="1"
                        [max]="item.product.stock"
                        [value]="item.quantity"
                        (input)="
                          setQuantity(
                            item.product.id,
                            $any($event.target).value
                          )
                        "
                        class="h-12 w-28 rounded-xl border border-[#8B6F47]/40 bg-white px-4 text-sm sm:text-base text-[#4B3621] outline-none focus:border-[#4B3621]"
                      />
                    </div>

                    <p
                      class="text-base sm:text-lg font-extrabold text-[#4B3621]"
                    >
                      ${{ item.lineTotal }}
                    </p>
                  </div>
                </div>
              }
            </div>

            <!-- Totales -->
            <div
              class="mt-5 rounded-2xl border border-[#4B3621]/10 bg-[#F5F5DC]/80 p-4"
            >
              <div
                class="flex items-center justify-between text-sm sm:text-base"
              >
                <span class="text-[#6E5C4B]">Subtotal</span>
                <span class="font-extrabold text-[#4B3621]"
                  >${{ subtotal }}</span
                >
              </div>

              @if (discountPercent > 0) {
                <div
                  class="mt-2 flex items-center justify-between text-sm sm:text-base"
                >
                  <span class="text-[#6E5C4B]"
                    >Descuento ({{ discountPercent }}%)</span
                  >
                  <span class="font-extrabold text-[#4B3621]"
                    >-${{ discountAmount }}</span
                  >
                </div>
              }

              <div
                class="mt-3 flex items-center justify-between text-base sm:text-lg"
              >
                <span class="font-extrabold text-[#4B3621]">Total</span>
                <span class="text-xl font-black text-[#4B3621]"
                  >${{ total }}</span
                >
              </div>
            </div>

            <!-- Metodo de pago -->
            <div
              class="mt-4 rounded-2xl border border-[#4B3621]/10 bg-white/70 p-4"
            >
              <p class="text-sm sm:text-base font-extrabold text-[#4B3621]">
                Método de pago
              </p>
              <p class="text-xs sm:text-sm text-[#6E5C4B] mt-1">
                Selecciona como pagará el cliente
              </p>

              <div class="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-3">
                <!-- Efectivo -->
                <button
                  type="button"
                  (click)="paymentMethod = 'cash'"
                  [disabled]="paying"
                  class="h-14 rounded-2xl px-4 text-sm sm:text-base font-extrabold transition-all active:scale-[0.99] disabled:opacity-60 disabled:cursor-not-allowed border"
                  [class]="
                    paymentMethod === 'cash'
                      ? 'bg-[#FFBF00] text-[#4B3621] border-[#4B3621]/20 shadow-sm'
                      : 'bg-white/80 text-[#4B3621] border-[#4B3621]/15 hover:bg-[#F5F5DC]'
                  "
                >
                  Efectivo
                </button>

                <!-- Tarjeta -->
                <button
                  type="button"
                  (click)="paymentMethod = 'card'"
                  [disabled]="paying"
                  class="h-14 rounded-2xl px-4 text-sm sm:text-base font-extrabold transition-all active:scale-[0.99] disabled:opacity-60 disabled:cursor-not-allowed border"
                  [class]="
                    paymentMethod === 'card'
                      ? 'bg-[#FFBF00] text-[#4B3621] border-[#4B3621]/20 shadow-sm'
                      : 'bg-white/80 text-[#4B3621] border-[#4B3621]/15 hover:bg-[#F5F5DC]'
                  "
                >
                  Tarjeta
                </button>

                <!-- Transferencia -->
                <button
                  type="button"
                  (click)="paymentMethod = 'transfer'"
                  [disabled]="paying"
                  class="h-14 rounded-2xl px-4 text-sm sm:text-base font-extrabold transition-all active:scale-[0.99] disabled:opacity-60 disabled:cursor-not-allowed border"
                  [class]="
                    paymentMethod === 'transfer'
                      ? 'bg-[#FFBF00] text-[#4B3621] border-[#4B3621]/20 shadow-sm'
                      : 'bg-white/80 text-[#4B3621] border-[#4B3621]/15 hover:bg-[#F5F5DC]'
                  "
                >
                  Transferencia
                </button>
              </div>

              <!-- Confirmar antes -->
              <p class="mt-3 text-xs sm:text-sm text-[#6E5C4B]">
                Seleccionado:
                <span class="font-extrabold text-[#4B3621]">
                  {{ paymentLabels[paymentMethod] }}
                </span>
              </p>
            </div>

            <!-- Cobrar -->
            <button
              data-testid="pay-btn"
              type="button"
              (click)="pay()"
              [disabled]="paying || cart.length === 0"
              class="mt-4 h-14 w-full rounded-2xl bg-[#4B3621] text-[#F5F5DC] text-base font-black hover:opacity-95 active:scale-[0.99] disabled:opacity-60"
            >
              @if (paying) {
                Procesando...
              } @else {
                Cobrar
              }
            </button>
          }
        </div>

        <!-- Card Ticket -->
        @if (lastTicket) {
          <div
            data-testid="ticket-card"
            class="rounded-2xl border border-[#4B3621]/15 bg-white/70 p-5"
          >
            <h3 class="text-base sm:text-lg font-extrabold text-[#4B3621]">
              Ticket
            </h3>

            <div
              class="mt-3 rounded-2xl border border-[#4B3621]/10 bg-white/80 p-4"
            >
              <div class="flex items-center justify-between">
                <p class="text-base font-black text-[#4B3621]">
                  {{ lastTicket.storeName }}
                </p>
                <p class="text-xs text-[#6E5C4B]">
                  {{ lastTicket.timestamp }}
                </p>
              </div>

              <p class="mt-2 text-sm text-[#6E5C4B]">
                Folio:
                <span class="font-extrabold text-[#4B3621]">
                  {{ lastTicket.saleId }}
                </span>
              </p>

              <div class="mt-3 space-y-1">
                @for (t of lastTicket.items; track t.name) {
                  <div class="flex items-center justify-between text-sm">
                    <span class="text-[#4B3621]"
                      >{{ t.qty }} × {{ t.name }}</span
                    >
                    <span class="font-extrabold text-[#4B3621]"
                      >${{ t.lineTotal }}</span
                    >
                  </div>
                }
              </div>

              <div
                class="mt-4 border-t border-[#4B3621]/10 pt-3 space-y-1 text-sm"
              >
                <div class="flex items-center justify-between">
                  <span class="text-[#6E5C4B]">Subtotal</span>
                  <span class="font-extrabold text-[#4B3621]">
                    ${{ lastTicket.subtotal }}
                  </span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-[#6E5C4B]">Descuento</span>
                  <span class="font-extrabold text-[#4B3621]">
                    {{ lastTicket.discount }}
                  </span>
                </div>
                <div class="flex items-center justify-between text-base">
                  <span class="font-extrabold text-[#4B3621]">Total</span>
                  <span class="text-lg font-black text-[#4B3621]">
                    ${{ lastTicket.total }}
                  </span>
                </div>
              </div>
            </div>
          </div>
        }
        @if (lastTicket) {
          <div
            class="mt-6 rounded-2xl border border-[#4B3621]/15 bg-white/70 p-5"
          >
            <div class="flex items-center justify-between gap-3">
              <h3 class="text-base sm:text-lg font-extrabold text-[#4B3621]">
                Ticket generado
              </h3>

              <button
                data-testid="ticket-print-btn"
                type="button"
                (click)="printTicket()"
                class="h-12 rounded-xl bg-[#4B3621] px-5 text-sm font-extrabold text-[#F5F5DC] hover:opacity-95 active:scale-[0.99]"
              >
                Imprimir
              </button>
            </div>

            <p class="mt-2 text-sm text-[#6E5C4B]">
              Folio:
              <span class="font-extrabold text-[#4B3621]">{{
                lastTicket.saleId
              }}</span>
              · Total:
              <span class="font-extrabold text-[#4B3621]">{{
                lastTicket.total
              }}</span>
            </p>
          </div>
        }
      </section>
    </div>
  }
</main>
