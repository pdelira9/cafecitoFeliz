<div class="h-full bg-[#F5F5DC] overflow-hidden flex flex-col">
  <div class="shrink-0">
    <div
      class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3"
    >
      <div>
        <h2 class="text-xl sm:text-2xl font-black text-[#4B3621]">
          Historial de Ventas
        </h2>
        <p class="text-sm text-[#6E5C4B]">
          Consulta, reimpresión y cancelaciones
        </p>
      </div>

      <div class="flex flex-wrap gap-2">
        <button
          type="button"
          (click)="setStatus('all')"
          class="h-11 rounded-xl px-4 text-sm font-extrabold border border-[#4B3621]/25"
          [class.bg-[#4B3621]]="status === 'all'"
          [class.text-[#F5F5DC]]="status === 'all'"
          [class.bg-white]="status !== 'all'"
          [class.text-[#4B3621]]="status !== 'all'"
        >
          Todas
        </button>

        <button
          type="button"
          (click)="setStatus('completed')"
          class="h-11 rounded-xl px-4 text-sm font-extrabold border border-[#4B3621]/25"
          [class.bg-[#4B3621]]="status === 'completed'"
          [class.text-[#F5F5DC]]="status === 'completed'"
          [class.bg-white]="status !== 'completed'"
          [class.text-[#4B3621]]="status !== 'completed'"
        >
          Completadas
        </button>

        <button
          type="button"
          (click)="setStatus('canceled')"
          class="h-11 rounded-xl px-4 text-sm font-extrabold border border-[#4B3621]/25"
          [class.bg-[#4B3621]]="status === 'canceled'"
          [class.text-[#F5F5DC]]="status === 'canceled'"
          [class.bg-white]="status !== 'canceled'"
          [class.text-[#4B3621]]="status !== 'canceled'"
        >
          Canceladas
        </button>
      </div>
    </div>
  </div>

  <!-- Buscador -->
  <div class="shrink-0">
    <div class="mt-5 rounded-2xl border border-[#4B3621]/15 bg-white/70 p-4">
      <div class="flex flex-col sm:flex-row gap-3 items-end">
        <div class="flex-1">
          <label class="block text-xs font-bold text-[#6E5C4B] mb-1"
            >Buscar por folio</label
          >
          <input
            type="text"
            class="h-12 w-full rounded-xl border border-[#8B6F47]/40 bg-white/80 px-4 text-sm sm:text-base text-[#4B3621] outline-none focus:border-[#4B3621]"
            placeholder="Ej. CF-20260220-1234"
            [value]="q"
            (input)="q = $any($event.target).value"
            (keydown.enter)="onSearch()"
          />
        </div>

        <button
          type="button"
          (click)="onSearch()"
          class="h-12 rounded-xl bg-[#4B3621] px-6 text-sm sm:text-base font-extrabold text-[#F5F5DC] hover:opacity-95 active:scale-[0.99]"
        >
          Buscar
        </button>

        <button
          type="button"
          (click)="clearSearch()"
          class="h-12 rounded-xl bg-[#FFBF00] px-6 text-sm sm:text-base font-extrabold text-[#4B3621] hover:brightness-95 active:scale-[0.99]"
        >
          Limpiar
        </button>
      </div>
    </div>
  </div>

  @if (loading) {
    <div class="mt-5 rounded-2xl border border-[#4B3621]/15 bg-white/70 p-6">
      <p class="text-sm text-[#6E5C4B]">Cargando ventas...</p>
    </div>
  } @else if (errorMsg) {
    <div class="mt-5 rounded-2xl border border-red-500/20 bg-red-50 p-6">
      <p class="text-sm text-red-700">{{ errorMsg }}</p>
    </div>
  } @else {
    @if (sales.length === 0) {
      <div class="mt-5 rounded-2xl border border-[#4B3621]/15 bg-white/70 p-6">
        <p class="text-sm text-[#6E5C4B]">
          @if (hasLoadedOnce) {
            No hay ventas con ese filtro/búsqueda.
          } @else {
            Sin datos.
          }
        </p>
      </div>
    } @else {
      <!-- Tabla Lista -->
      <div class="flex-1 min-h-0 overflow-hidden">
        <div
          class="h-full rounded-2xl border border-[#4B3621]/15 bg-white/70 overflow-hidden flex flex-col"
        >
          <div class="flex-1 min-h-0 overflow-auto">
            <table class="w-full text-left">
              <thead class="bg-[#4B3621] text-[#F5F5DC] sticky top-0 z-10">
                <tr>
                  <th
                    class="px-4 py-3 text-xs font-black uppercase tracking-wide"
                  >
                    Folio
                  </th>
                  <th
                    class="px-4 py-3 text-xs font-black uppercase tracking-wide"
                  >
                    Estado
                  </th>
                  <th
                    class="px-4 py-3 text-xs font-black uppercase tracking-wide"
                  >
                    Total
                  </th>
                  <th
                    class="px-4 py-3 text-xs font-black uppercase tracking-wide"
                  >
                    Pago
                  </th>
                  <th
                    class="px-4 py-3 text-xs font-black uppercase tracking-wide"
                  >
                    Fecha
                  </th>
                  <th
                    class="px-4 py-3 text-xs font-black uppercase tracking-wide text-right"
                  >
                    Acciones
                  </th>
                </tr>
              </thead>

              <tbody>
                @for (s of sales; track s.saleId) {
                  <tr class="border-t border-[#4B3621]/10">
                    <td
                      class="px-4 py-3 text-sm font-extrabold text-[#4B3621] whitespace-nowrap"
                    >
                      {{ s.saleId }}
                    </td>

                    <td class="px-4 py-3">
                      @if (s.status === "completed") {
                        <span
                          class="inline-flex rounded-full bg-[#FFBF00]/30 px-3 py-1 text-xs font-black text-[#4B3621]"
                        >
                          COMPLETADA
                        </span>
                      } @else {
                        <span
                          class="inline-flex rounded-full bg-red-100 px-3 py-1 text-xs font-black text-red-700"
                        >
                          CANCELADA
                        </span>
                      }
                    </td>

                    <td
                      class="px-4 py-3 text-sm font-black text-[#4B3621] whitespace-nowrap"
                    >
                      {{ formatMoney(s.total) }}
                    </td>

                    <td
                      class="px-4 py-3 text-sm text-[#6E5C4B] whitespace-nowrap"
                    >
                      {{ s.paymentMethod }}
                    </td>

                    <td
                      class="px-4 py-3 text-sm text-[#6E5C4B] whitespace-nowrap"
                    >
                      {{ formatDate(s.createdAt) }}
                    </td>

                    <td class="px-4 py-3 text-right">
                      @if (s.status === "completed") {
                        <button
                          type="button"
                          (click)="cancelSale(s.saleId)"
                          [disabled]="cancelingSaleId === s.saleId"
                          class="h-11 rounded-xl bg-[#4B3621] px-4 text-sm font-extrabold text-[#F5F5DC] hover:opacity-95 active:scale-[0.99] disabled:opacity-60"
                        >
                          @if (cancelingSaleId === s.saleId) {
                            Cancelando...
                          } @else {
                            Cancelar
                          }
                        </button>
                      } @else {
                        <span class="text-xs text-[#6E5C4B]">—</span>
                      }
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>

          <div
            class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 px-4 py-3 border-t border-[#4B3621]/10"
          >
            <p class="text-xs sm:text-sm text-[#6E5C4B]">
              Página
              <span class="font-black text-[#4B3621]">{{ page }}</span> de
              <span class="font-black text-[#4B3621]">{{ totalPages }}</span>
              · Total:
              <span class="font-black text-[#4B3621]">{{ total }}</span>
            </p>

            <div class="flex gap-2">
              <button
                type="button"
                (click)="prevPage()"
                [disabled]="page <= 1"
                class="h-11 rounded-xl border border-[#4B3621]/25 bg-white px-4 text-sm font-extrabold text-[#4B3621] hover:bg-[#F5F5DC] disabled:opacity-50"
              >
                Anterior
              </button>
              <button
                type="button"
                (click)="nextPage()"
                [disabled]="page * limit >= total"
                class="h-11 rounded-xl bg-[#FFBF00] px-4 text-sm font-extrabold text-[#4B3621] hover:brightness-95 disabled:opacity-50"
              >
                Siguiente
              </button>
            </div>
          </div>
        </div>
      </div>
    }
  }
</div>
